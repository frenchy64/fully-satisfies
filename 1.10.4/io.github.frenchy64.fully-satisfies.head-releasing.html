<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>io.github.frenchy64.fully-satisfies.head-releasing documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Fully-satisfies</span> <span class="project-version">1.10.4</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>io</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>github</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>frenchy64</span></div></div></li><li class="depth-4"><a href="io.github.frenchy64.fully-satisfies.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fully-satisfies</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.clearing-future.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clearing-future</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.everyp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>everyp</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.expand-kvs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>expand-kvs</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.folda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>folda</span></div></a></li><li class="depth-5 branch current"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>head-releasing</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.latest-protocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>latest-protocol</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.lazier.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazier</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>leaky-seq-detection</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.linear.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linear</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.never.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>never</span></div></a></li><li class="depth-5"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>non-leaky-macros</span></div></div></li><li class="depth-6"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clojure</span></div></div></li><li class="depth-7"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-8 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-8"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>logic</span></div></div></li><li class="depth-9"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.logic.pldb.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pldb</span></div></a></li><li class="depth-8"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>match</span></div></div></li><li class="depth-9"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.match.debug.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debug</span></div></a></li><li class="depth-7"><div class="no-link"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>java</span></div></div></li><li class="depth-8 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.java.jmx.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jmx</span></div></a></li><li class="depth-8"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.java.shell.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>shell</span></div></a></li><li class="depth-7 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.pprint.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>pprint</span></div></a></li><li class="depth-7"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-8"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>check</span></div></div></li><li class="depth-9 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.check.generators.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generators</span></div></a></li><li class="depth-9"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.check.properties.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>properties</span></div></a></li><li class="depth-8"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.tap.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tap</span></div></a></li><li class="depth-7"><div class="no-link"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>tools</span></div></div></li><li class="depth-8"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.tools.trace.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>trace</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.partially-satisfies.html"><div class="inner"><span class="tree" style="top: -579px;"><span class="top" style="height: 588px;"></span><span class="bottom"></span></span><span>partially-satisfies</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.reify-spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reify-spec</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.run-all.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>run-all</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.safer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>safer</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.shared-protocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>shared-protocol</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.somef.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>somef</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.uncaught-testing-contexts.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uncaught-testing-contexts</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.uniform.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uniform</span></div></a></li><li class="depth-5"><a href="io.github.frenchy64.fully-satisfies.vector-overflow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>vector-overflow</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-every.3F"><div class="inner"><span>every?</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-keep"><div class="inner"><span>keep</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-keep-indexed"><div class="inner"><span>keep-indexed</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-map"><div class="inner"><span>map</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-map-indexed"><div class="inner"><span>map-indexed</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-mapcat"><div class="inner"><span>mapcat</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-naive-seq-reduce"><div class="inner"><span>naive-seq-reduce</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-not-any.3F"><div class="inner"><span>not-any?</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-not-every.3F"><div class="inner"><span>not-every?</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html#var-some"><div class="inner"><span>some</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">io.github.frenchy64.fully-satisfies.head-releasing</h1><div class="doc"><pre class="plaintext">Variants of clojure.core functions (and internal helpers)
that release the head of seqs earlier, enabling lower peak memory
usage in some cases.

For example, many higher-order functions in this namespace release strong
references to arguments before calling their function arguments.
Realizing the following example would be prone to failure with an OutOfMemoryError using
clojure.core/map because map retains a strong reference to takes-75-percent-of-heap
when calling its function argument, which prevents memory from being reclaimed to create
another value of that size.

(map (fn [takes-75-percent-of-heap]
       (if (&lt; (rand) 0.5)
         takes-75-percent-of-heap
         (generate-another-value-taking-75-percent-of-heap)))
     [takes-75-percent-of-heap])

In contrast, using head-releasing/map, the garbage collector can reclaim takes-75-percent-of-heap
while calculating (generate-another-value-taking-75-percent-of-heap) because
head-releasing/map does not strongly reference takes-75-percent-of-heap at that point.

The basic implementation trick to achieving this is to call (rest s) on the seq currently
being processed _before_ calling (f (first f)), so the strong reference to (first f)
is transferred from the higher-order function to f during the call to f.

There are potential caveats to this approach: <a href="https://clojure.org/reference/lazy#_extension_iseqs">https://clojure.org/reference/lazy#_extension_iseqs</a>
If the underlying ISeq implementation defines rest in terms of next as in the article, then the
functions in this namespace will force two seq elements into memory simultaneously.
For example, the call below will throw an OutOfMemoryError before the fn is called because both
elements of the seq will be realized.

(map (fn [takes-75-percent-of-heap] nil)
     (lazy-seq-where-rest-calls-next
       (cons (-&gt;takes-75-percent-of-heap)
             (lazy-seq [(-&gt;takes-75-percent-of-heap)]))))

Infinite lazy seqs such as cycle or repeat always hold strong references to all their elements, so
the functions in this namespace will have no affect in the memory usage of processing these seqs.

Another caveat is that the functions here are perhaps more useful as
validation of the leaky-seq-detection framework and for pedalogical purposes about sequences
than as significant bump in real-world expressivity.
See the tests for how these implementations were verified:
  io.github.frenchy64.fully-satisfies.leaky-seq-detection-test

The author of this namespace can only speculate why the original functions were written this way.
Perhaps the idea of a fn releasing a strong reference to one of its arguments was too rare to risk
the caveats in using the default implementation of ISeq. Chunked seqs are also so prevalent
and have much higher memory requirements that the optimizations in this namespace might
have been deemed insignificant. For example, map processing a chunk of 32 must have enough memory
to hold both 32 elements of the input collection and 32 elements of the output collection simultaneously.
Chunked seqs also make programs such as the above unidiomatic since they are so difficult to get right
(see the hoops math.combinatorics jumps through to reduce the 32+32 elements of the previous example to
32+1).

At the very least, this work helps crystallize the differences between rest and next---or
more precisely, their similarities: while rest does not realize the next element, nor tell us whether
a seq has more elements, it is still an eager operation whose result, like next, releases a strong
reference to the first element of the seq.</pre></div><div class="public anchor" id="var-every.3F"><h3>every?</h3><h4 class="added">added in 1.0</h4><div class="usage"><code>(every? pred coll)</code></div><div class="doc"><pre class="plaintext">Returns true if (pred x) is logical true for every x in coll, else
false.

head-releasing/every? is additionally:
- thread-safe for mutable collections
- does not hold strong reference to argument of pred when it is called.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L89">view source</a></div></div><div class="public anchor" id="var-keep"><h3>keep</h3><h4 class="added">added in 1.2</h4><div class="usage"><code>(keep f)</code><code>(keep f coll)</code></div><div class="doc"><pre class="plaintext">Returns a lazy sequence of the non-nil results of (f item). Note,
this means false return values will be included.  f must be free of
side-effects.  Returns a transducer when no collection is provided.

Additionally, head-releasing/keep does not hold a strong reference
to the argument of f when it is called (unless a single chunked seq coll is provided).</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L239">view source</a></div></div><div class="public anchor" id="var-keep-indexed"><h3>keep-indexed</h3><h4 class="added">added in 1.2</h4><div class="usage"><code>(keep-indexed f)</code><code>(keep-indexed f coll)</code></div><div class="doc"><pre class="plaintext">Returns a lazy sequence of the non-nil results of (f index item). Note,
this means false return values will be included.  f must be free of
side-effects.  Returns a stateful transducer when no collection is
provided.

Additionally, head-releasing/keep-indexed does not hold a strong reference
to the argument of f when it is called (unless a single chunked seq coll is provided).</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L276">view source</a></div></div><div class="public anchor" id="var-map"><h3>map</h3><h4 class="added">added in 1.0</h4><div class="usage"><code>(map f)</code><code>(map f coll)</code><code>(map f c1 c2)</code><code>(map f c1 c2 c3)</code><code>(map f c1 c2 c3 &amp; colls)</code></div><div class="doc"><pre class="plaintext">Returns a lazy sequence consisting of the result of applying f to
the set of first items of each coll, followed by applying f to the
set of second items in each coll, until any one of the colls is
exhausted.  Any remaining items in other colls are ignored. Function
f should accept number-of-colls arguments. Returns a transducer when
no collection is provided.

Additionally, head-releasing/map does not hold a strong reference
to the arguments of f when it is called (unless a single chunked seq coll is provided).</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L119">view source</a></div></div><div class="public anchor" id="var-map-indexed"><h3>map-indexed</h3><h4 class="added">added in 1.2</h4><div class="usage"><code>(map-indexed f)</code><code>(map-indexed f coll)</code></div><div class="doc"><pre class="plaintext">Returns a lazy sequence consisting of the result of applying f to 0
and the first item of coll, followed by applying f to 1 and the second
item in coll, etc, until coll is exhausted. Thus function f should
accept 2 arguments, index and item. Returns a stateful transducer when
no collection is provided.

Additionally, head-releasing/map-indexed does not hold a strong reference
to the argument of f when it is called (unless a single chunked seq coll is provided).</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L205">view source</a></div></div><div class="public anchor" id="var-mapcat"><h3>mapcat</h3><h4 class="added">added in 1.0</h4><div class="usage"><code>(mapcat f)</code><code>(mapcat f &amp; colls)</code></div><div class="doc"><pre class="plaintext">Returns the result of applying concat to the result of applying map
to f and colls.  Thus function f should return a collection. Returns
a transducer when no collections are provided.

Additionally, head-releasing/mapcat does not hold strong references to
the arguments of f when it is called (unless a single chunked seq coll is provided).</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L318">view source</a></div></div><div class="public anchor" id="var-naive-seq-reduce"><h3>naive-seq-reduce</h3><div class="usage"><code>(naive-seq-reduce s f val)</code></div><div class="doc"><pre class="plaintext">Reduces a seq, ignoring any opportunities to switch to a more
specialized implementation.

Additionally, head-releasing/naive-seq-reduce does not retain
a strong reference to the arguments of f when it is called.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L72">view source</a></div></div><div class="public anchor" id="var-not-any.3F"><h3>not-any?</h3><h4 class="added">added in 1.0</h4><div class="usage"><code>(not-any? pred coll)</code></div><div class="doc"><pre class="plaintext">Returns false if (pred x) is logical true for any x in coll,
else true.
      
Additionally, head-releasing/not-any? does not hold a strong reference
to the argument of pred when it is called.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L194">view source</a></div></div><div class="public anchor" id="var-not-every.3F"><h3>not-every?</h3><h4 class="added">added in 1.0</h4><div class="usage"><code>(not-every? pred coll)</code></div><div class="doc"><pre class="plaintext">Returns false if (pred x) is logical true for every x in
coll, else true.

Additionally, head-releasing/not-every? does not hold a strong reference
to the argument of pred when it is called.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L108">view source</a></div></div><div class="public anchor" id="var-some"><h3>some</h3><h4 class="added">added in 1.0</h4><div class="usage"><code>(some pred coll)</code></div><div class="doc"><pre class="plaintext">Returns the first logical true value of (pred x) for any x in coll,
else nil.  One common idiom is to use a set as pred, for example
this will return :fred if :fred is in the sequence, otherwise nil:
(some #{:fred} coll)

Additionally, head-releasing/some does not hold a strong reference
to the argument of pred when it is called.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/23a751b1123fd39191db9a10f9070d1b5f148772/src/io/github/frenchy64/fully_satisfies/head_releasing.clj#L178">view source</a></div></div></div></body></html>