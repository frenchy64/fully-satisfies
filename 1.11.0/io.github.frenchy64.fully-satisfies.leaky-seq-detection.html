<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>io.github.frenchy64.fully-satisfies.leaky-seq-detection documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Fully-satisfies</span> <span class="project-version">1.11.0</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>io</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>github</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>frenchy64</span></div></div></li><li class="depth-4"><a href="io.github.frenchy64.fully-satisfies.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fully-satisfies</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.clearing-future.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clearing-future</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.everyp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>everyp</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.expand-kvs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>expand-kvs</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.folda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>folda</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.head-releasing.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>head-releasing</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.latest-protocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>latest-protocol</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.lazier.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazier</span></div></a></li><li class="depth-5 branch current"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>leaky-seq-detection</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.linear.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linear</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.never.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>never</span></div></a></li><li class="depth-5"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>non-leaky-macros</span></div></div></li><li class="depth-6"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clojure</span></div></div></li><li class="depth-7"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-8 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-8"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>logic</span></div></div></li><li class="depth-9"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.logic.pldb.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pldb</span></div></a></li><li class="depth-8"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>match</span></div></div></li><li class="depth-9"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.core.match.debug.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debug</span></div></a></li><li class="depth-7"><div class="no-link"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>java</span></div></div></li><li class="depth-8 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.java.jmx.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jmx</span></div></a></li><li class="depth-8"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.java.shell.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>shell</span></div></a></li><li class="depth-7 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.pprint.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>pprint</span></div></a></li><li class="depth-7"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-8"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>check</span></div></div></li><li class="depth-9 branch"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.check.generators.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generators</span></div></a></li><li class="depth-9"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.check.properties.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>properties</span></div></a></li><li class="depth-8"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.test.tap.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tap</span></div></a></li><li class="depth-7"><div class="no-link"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>tools</span></div></div></li><li class="depth-8"><a href="io.github.frenchy64.fully-satisfies.non-leaky-macros.clojure.tools.trace.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>trace</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.partially-satisfies.html"><div class="inner"><span class="tree" style="top: -579px;"><span class="top" style="height: 588px;"></span><span class="bottom"></span></span><span>partially-satisfies</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.reify-spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reify-spec</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.requiring-resolve.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>requiring-resolve</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.run-all.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>run-all</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.safer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>safer</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.shared-protocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>shared-protocol</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.somef.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>somef</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.uncaught-testing-contexts.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uncaught-testing-contexts</span></div></a></li><li class="depth-5 branch"><a href="io.github.frenchy64.fully-satisfies.uniform.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uniform</span></div></a></li><li class="depth-5"><a href="io.github.frenchy64.fully-satisfies.vector-overflow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>vector-overflow</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html#var-is-strong"><div class="inner"><span>is-strong</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html#var-ref-counting-chunked-seq"><div class="inner"><span>ref-counting-chunked-seq</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html#var-ref-counting-lazy-seq"><div class="inner"><span>ref-counting-lazy-seq</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html#var-register-cleaner.21"><div class="inner"><span>register-cleaner!</span></div></a></li><li class="depth-1"><a href="io.github.frenchy64.fully-satisfies.leaky-seq-detection.html#var-try-forcing-cleaners.21"><div class="inner"><span>try-forcing-cleaners!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">io.github.frenchy64.fully-satisfies.leaky-seq-detection</h1><div class="doc"><pre class="plaintext">A framework to detect memory leaks caused by holding onto the head of sequences.

The java.lang.ref.Cleaner class (JDK9+) provides hooks into garbage
collection. You can register a function that is called when a value
becomes phantom reachable, indicating is it a candidate for garbage
collection.

The JVM is very likely to perform garbage collection
right before throwing an OutOfMemoryError. Part of garbage
collection is calculating whether references are reachable.
We use this insight to force garbage collection (and hence, cleaners)
to run, by inducing an OutOfMemoryError in try-forcing-cleaners!.

Note that an OutOfMemoryError can leave the JVM in a bad state, so
this strategy is best isolated away from other tests. It is unclear
whether this helps mitigate any such issues or has any affect whatsoever,
but try-forcing-cleaners! requests large blocks of memory at a time
in the hope that when the JVM does refuse to allocate more memory,
there is a better chance that sufficient memory will be left over for
normal execution. Suggestions welcome for better strategies.

Tying these ideas together are reference-counting seqs and the is-strong
testing macro. ref-counting-lazy-seq returns a lazy seq
and an atom of all elements of the seq currently with strong references.
This seq can now be passed to a sequence-processing function you would
like to test for memory leaks.

is-strong then takes a set of seq indexes expected to have strong references
and checks them against the atom tracking strong references. It will continue
to induce OutOfMemoryError's until the expected references are found, or eventually
fail via an is test assertion.

Note that it's best to build up the set of expected strong references rather than
whittle it down. From a usability standpoint, starting with (is-strong #{} live)
will likely print the actual set of strongly referenced indexes, from which you can
source the expected strong references (from the result itself or a subset).
But false-positives are possible if an overly broad superset of the actual strong references are provided,
since is-strong may short-circuit its search earlier than the cleaners can run.
Such results can lead to false conclusions about how lazy a function actually is, especially
if you have a pre-conceived notion of the results! The JVM property
  io.github.frenchy64.fully-satisfies.leaky-seq-detection.is-strong.false-positive-detection=true
will more aggressively search for such false-positives, which may be suitable for a cron CI job.

Here's an example of asserting that a program adds or subtracts strong references to elements
of a lazy seq at particular points.

(deftest example-cleaners-test
  (let [{:keys [strong lseq]} (ref-counting-lazy-seq
                                {:n 10}) ;; seq of fresh Object's, length 10
        ;; lseq=(...)
        _ (is-strong #{} strong) ;; no elements currently in memory
        lseq (seq lseq)
        ;; lseq=(0 ...)
        _ (is-strong #{0} strong) ;; just the first element in memory
        _ (nnext lseq)
        ;; lseq=(0 1 2...)
        _ (is-strong #{0 1 2} strong) ;; the first 3 elements in memory
        lseq (next lseq)
        ;; lseq=(1 2 ...)
        _ (is-strong #{1 2} strong) ;; the second 2 elements in memory
        lseq (rest lseq)
        ;; lseq=(2 ...)
        _ (is-strong #{2} strong) ;; the third element in memory
        lseq (rest lseq)
        ;; lseq=(...)
        _ (is-strong #{} strong) ;; no elements in memory
        ;; lseq=(3 ...)
        lseq (seq lseq)
        _ (is-strong #{3} strong) ;; fourth element in memory
        _ (class (first lseq)) ;; add a strong reference to lseq so previous line succeeds
        ;; lseq=nil
        _ (is-strong #{} strong) ;; lseq is entirely garbage collected
        ]))

See io.github.frenchy64.fully-satisfies.leaky-seq-detection-test for real-world
examples of finding memory leaks in Clojure functions, and then verifying fixes for them.</pre></div><div class="public anchor" id="var-is-strong"><h3>is-strong</h3><div class="usage"><code>(is-strong expected strong)</code></div><div class="doc"><pre class="plaintext">Asserts that there are strong references to the expected set of indexes
into the ref-counting seq associated with strong by yielding OutOfMemoryError's
via [[try-forcing-cleaners!]].

Short-circuits if expected set equals actual set.

Setting the system property:
  io.github.frenchy64.fully-satisfies.leaky-seq-detection.is-strong.false-positive-detection=true
will prevent short-circuiting in order to detect false-positives (see also leaky-seq-detection's docstring).</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/d0aafa6b8af5d37b2d4d0bd688f6678f5bcbd883/src/io/github/frenchy64/fully_satisfies/leaky_seq_detection.clj#L196">view source</a></div></div><div class="public anchor" id="var-ref-counting-chunked-seq"><h3>ref-counting-chunked-seq</h3><div class="usage"><code>(ref-counting-chunked-seq)</code><code>(ref-counting-chunked-seq {:keys [i-&gt;v chunk-size n], :or {i-&gt;v (fn [{:keys [i end]}] (Object.)), n ##Inf, chunk-size 32}})</code></div><div class="doc"><pre class="plaintext">Returns a map with entries:
- :lseq, a lazily chunked sequence of length n (default ##Inf) where each element is a distinct fresh Object entity, or 
  the result of (i-&gt;v {:i &lt;index&gt; :end eos}) when provided. Chunks are of size chunk-size (default 32).
  Returning :end key from i-&gt;v arg also ends the sequence.
- :strong, an atom containing a set of indicies whose values are (likely) currently strong references.

For the most precise results, each element returned by i-&gt;v should be distinct according to identical?
from all other values in the current JVM environment.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/d0aafa6b8af5d37b2d4d0bd688f6678f5bcbd883/src/io/github/frenchy64/fully_satisfies/leaky_seq_detection.clj#L144">view source</a></div></div><div class="public anchor" id="var-ref-counting-lazy-seq"><h3>ref-counting-lazy-seq</h3><div class="usage"><code>(ref-counting-lazy-seq)</code><code>(ref-counting-lazy-seq {:keys [i-&gt;v n], :or {i-&gt;v (fn [{:keys [i end]}] (Object.)), n ##Inf}})</code></div><div class="doc"><pre class="plaintext">Returns a map with entries:
- :lseq, an lazy sequence of length n (default ##Inf) where each element is a distinct fresh Object entity, or 
  the result of (i-&gt;v {:i &lt;index&gt; :end &lt;eos&gt;}) when provided. Returning :end key from i-&gt;v arg also ends the sequence.
- :strong, an atom containing a set of indicies whose values are (likely) currently strong references.

For the most precise results, each element returned by i-&gt;v should be distinct according to identical?
from all other values in the current JVM environment.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/d0aafa6b8af5d37b2d4d0bd688f6678f5bcbd883/src/io/github/frenchy64/fully_satisfies/leaky_seq_detection.clj#L118">view source</a></div></div><div class="public anchor" id="var-register-cleaner.21"><h3>register-cleaner!</h3><div class="usage"><code>(register-cleaner! v f)</code></div><div class="doc"><pre class="plaintext">Register a thunk to be called when object v
becomes phantom reachable.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/d0aafa6b8af5d37b2d4d0bd688f6678f5bcbd883/src/io/github/frenchy64/fully_satisfies/leaky_seq_detection.clj#L90">view source</a></div></div><div class="public anchor" id="var-try-forcing-cleaners.21"><h3>try-forcing-cleaners!</h3><div class="usage"><code>(try-forcing-cleaners!)</code><code>(try-forcing-cleaners! f)</code></div><div class="doc"><pre class="plaintext">Induce an OutOfMemoryError in an attempt to force Cleaners,
including those registered by register-cleaner!.</pre></div><div class="src-link"><a href="https://github.com/frenchy64/fully-satisfies/blob/d0aafa6b8af5d37b2d4d0bd688f6678f5bcbd883/src/io/github/frenchy64/fully_satisfies/leaky_seq_detection.clj#L99">view source</a></div></div></div></body></html>